import { Component, Input, OnInit, OnDestroy, OnChanges, SimpleChanges } from '@angular/core';

import Tabulator from 'tabulator-tables';
import { FormGroup, ReactiveFormsModule,FormControl, ValidationErrors,FormBuilder } from '@angular/forms';
import { FormlyFormOptions, FormlyFieldConfig } from '@ngx-formly/core';
import { ActivatedRoute, Router, Routes } from '@angular/router';

import * as _ from 'underscore';
import { ToastrService } from 'ngx-toastr';
import * as cloneDeep from 'lodash/cloneDeep';

import { WpcoreService } from '../../wpcore.service';
import { WphelperModule } from '../../modules/wphelper.module';
import { TaxonomyModule } from '../../modules/taxonomy.module';



@Component({
  selector: 'taxonomy-form',
  templateUrl: './taxonomy-form.component.html',
  styleUrls: ['./taxonomy-form.component.scss']
})
export class TaxonomyFormComponent implements OnChanges {
  
  @Input() taxonomy_machine_name: string = 'category';
  @Input() taxonomy_name: string = 'Category';
  @Input() display_parent: boolean = false;


  title = 'DemoTabulator';
  terms: any[];
  columnNames: any[] = [];
  termTable: Tabulator;
  termTable_tag: Tabulator;
  find: string;
  bulkOps = {
    'select': 'Bulk Actions',
    'delete': 'Delete',
  };
  tab: any;


  tax_tree: any;
  form = new FormGroup({});
  model = { 
    name: "",
    slug: "",
    parent:0,
    description: "",
    taxonomy: "",
  };



  fields: FormlyFieldConfig[] = [];

  bulkActionsForm = this.fb.group({
    bulkaction: ['']
  });

  termSearchForm = this.fb.group({
    searchterm: ['']
  });  


  constructor (private wpcore: WpcoreService,  
    private wphelper: WphelperModule, 
    public taxo: TaxonomyModule,
    private toastr: ToastrService,
    public fb: FormBuilder) {
    this.tab = document.createElement('div');
    //this.initiate();
  }

  private tableDraw(): void{
    
    new Tabulator(this.tab, {
      data: this.terms,
      reactiveData:true, //enable data reactivity
      columns: this.columnNames,
      layout: 'fitData',
      height: "311px",
    });
    document.getElementById('tabulator-div-category').appendChild(this.tab);
  }

    ngOnChanges(changes: SimpleChanges): void {
    this.initiate();
  }


  initiate() {
    console.log("initiate started");
    
    this.tax_tree = this.taxo.getTaxonomyTree(this.taxonomy_machine_name);
    this.title = this.taxonomy_machine_name;
    switch(this.taxonomy_machine_name) {
      case 'category':
        this.display_parent = true;

      break;

      case 'post_tag': 
        this.display_parent = false;
      break;

      default:
    }

    var selector = this.wphelper.treeSort(this.tax_tree);
    this.defineFields(selector);
    this.getData();    
    this.tableDraw();
    //this.buildTable();
  }


  getData() {
    this.taxo.getTerms();
    this.terms = this.taxo.getTermsByTaxonomy(this.taxonomy_machine_name);
    console.log("in get data", this.terms);
  }


  defineFields(_parents?:any) {
    this.fields = [
      {
        key: 'name',
        type: 'input',
        //wrappers: ['form-field-horizontal'],
        templateOptions: {
          label: 'Name',
          type: 'text',
          placeholder: '',
          required: true,
          description: 'The name is how it appears on your site.',
        },
      },
      {
        key: 'slug',
        type: 'input',
        templateOptions: {
          label: 'Slug',
          type: 'text',
          placeholder: '',
          required: false,
          description: 'The “slug” is the URL-friendly version of the name. It is usually all lowercase and contains only letters, numbers, and hyphens.',
        },
      },
      {
        key: 'parent',
        type: 'select',
        className: this.display_parent ? 'display' : 'hidden', 
        defaultValue: 0,
        templateOptions: {
          label: 'Parent Category',
          required: false,
          description: this.taxonomy_name + ', unlike tags, can have a hierarchy. You might have a Jazz category, and under that have children categories for Bebop and Big Band. Totally optional.',
          options: _parents,
        },
      },       

      {
        key: 'description',
        type: 'textarea',
        templateOptions: {
          label: 'Description',
          type: 'textarea',
          placeholder: '',
          required: false,
          description: 'The description is not prominent by default; however, some themes may show it.',
        },
      },    

    ];
  }



  onSubmit() {
    var res = this.taxo.addTerm(this.model.name, this.taxonomy_machine_name, this.model.slug, this.model.description, this.model.parent);
    if(res.status) {
      this.toastr.success(res.message);
      this.refreshTable();
          this.model = {
            name: " ",
            slug: "",
            parent:0,
            description: "",
            taxonomy: "",            
          };      
    }
    else {
      this.toastr.error(res.message);
      console.log("error creating term", res.data);
    }
  }

  

  buildTable(): void {

    this.columnNames = [

      { title: "Select", width: 75, formatter:"rowSelection", titleFormatter:"rowSelection", align:"center", headerSort:false},
      { title: "Id", field: "term_id",visible:false },
      { title: "Name", field: "name" },
      { title: "Description", field: "description"},//,editor:"textarea" },
      { title: "Slug", field: "slug",editor:"input" },
      { title: "Count", field: "count",formatter:"link", formatterParams:{
        labelField:"Count",
        urlPrefix:"https://posts.com/postsbytax/",
        } 
      },
    ];
    
    var tab_settings = {
        layout: 'fitColumns',
        //selectable:true,
        dataTree:true,
        movableRows: true, //enable user movable rows
        columns:[
          {
            formatter:"rowSelection", 
            titleFormatter:"rowSelection", 
            align:"center", 
            headerSort:false
          },
          {
            rowHandle:true, 
            formatter:"handle",  
            headerSort:false, 
            frozen:true, 
            width:30, 
            minWidth:30},
        ]
    };    

    //this.terms = ;
if(this.taxonomy_machine_name == 'category') {
    var tab_selector = "#tabulator-div-" + this.taxonomy_machine_name;
    
    this.termTable = new Tabulator(tab_selector, tab_settings); 

    this.termTable.setColumns(this.columnNames);
    this.termTable.clearData();
    this.termTable.setData(this.terms);  
}
if(this.taxonomy_machine_name == 'post_tag') { 
    var tab_selector = "#tabulator-div-" + this.taxonomy_machine_name;
    
    this.termTable_tag = new Tabulator(tab_selector, tab_settings); 

    this.termTable_tag.setColumns(cloneDeep(this.columnNames));
    this.termTable_tag.clearData();
    this.termTable_tag.setData(cloneDeep(this.terms));  
}
  
    //this.termTable.setFilter(this.customFilter, {taxonomy: this.taxonomy_machine_name});
    console.log("in build,", this.taxonomy_machine_name, this.terms);
  }  

  ngOnInit() {
    this.initiate();
  }



  onSubmitbulkActionsForm() {
    var _counts = {
      total:0,
      deleted:0,
    };
    if(this.bulkActionsForm.get('bulkaction').value == 'delete') {  
      var rows = this.termTable.getRows("active");
      if(rows) {
        if(confirm("Are you sure to delete selected terms")) {
          for(let _index in rows) {
            var row = rows[_index];
            if(row.isSelected()) {
              var row_data = row.getData();
              if(row_data.term_id != 1) {
                _counts.total++;
                if(this.wpcore.deleteEntity(row_data.term_id, 'terms')) {
                  _counts.deleted++;
                }
              }
            }
          }
          this.refreshTable();
          this.toastr.success('Deleted!', "Deleted " + _counts.deleted + " of total " + _counts.total + ".");
        }
      }
      
      else {
        this.toastr.error("Error", "Nothing to delete, select atleast 1 item.");
      }


    } 
    

  }

  onSubmitTermSearchForm() {
    var _keyword = this.termSearchForm.get('searchterm').value; 
    if(_keyword) {
      this.termTable.clearFilter();
      this.termTable.setFilter(this.customFilter, {taxonomy: this.taxonomy_machine_name});
      var _filter = {
        field: "name",
        type: "like",
        value: _keyword,
      };
      this.termTable.setFilter([_filter]);
    }
    else {
      this.termTable.clearFilter();
      this.termTable.setFilter(this.customFilter, {taxonomy: this.taxonomy_machine_name});
    }
 
  }

  refreshTable() {    
    this.getData();
    this.termTable.replaceData(this.terms); 
    console.log("refreshTable started");
  }

  customFilter(data, filterParams){
      return data.taxonomy == filterParams.taxonomy; //must return a boolean, true if it passes the filter.
  }

}

@Component({
  selector: 'taxonomy-editform',
  templateUrl: './taxonomy-editform.component.html',
  styleUrls: ['./taxonomy-editform.component.scss']
})
export class TaxonomyEditFormComponent implements OnInit {




  ngOnInit(): void {
  
  }
}


@Component({
  selector: 'taxonomy',
  templateUrl: './taxonomy.component.html', 
  styleUrls: ['./taxonomy.component.scss']
})
export class TaxonomyComponent implements OnInit, OnDestroy {

  /*

  @Input() taxonomy_machine_name: string = "category";
  @Input() taxonomy_name: string = "Categories";
  display_parent = false;
  sub: any;

  constructor(public wpcore: WpcoreService, private route:ActivatedRoute, 
    private router: Router) { 

    //this.taxonomy_machine_name = this.actRoute.snapshot.params.taxonomy;



    
  }


  ngOnInit() {
    this.sub = this.route.data.subscribe(v => {
      this.taxonomy_machine_name = v.taxonomy;
      switch(this.taxonomy_machine_name) {
        case 'category':
          this.display_parent = true;
          this.taxonomy_name = 'Categories';
        break;

        case 'post_tag': 
          this.display_parent = false;
          this.taxonomy_name = 'Tags';
        break;

        default: 
      }        
    });
  }

  ngOnDestroy() {
    this.sub.unsubscribe();
  }
  */
  ngOnInit() {}
  ngOnDestroy() {}
}


@Component({
  selector: 'taxonomy-category',
  templateUrl: './taxonomy-category.component.html',  
})
export class TaxonomyCategoryComponent implements OnInit {
  ngOnInit() {
  }
}

@Component({
  selector: 'taxonomy-posttag',
  templateUrl: './taxonomy-posttag.component.html', 
})
export class TaxonomyPosttagComponent implements OnInit {
  ngOnInit() {
  }
}


